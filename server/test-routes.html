<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Polyindex API Route Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            padding: 20px;
            background: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 30px;
            color: #2c3e50;
        }

        .section {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        h2 {
            margin-bottom: 15px;
            color: #34495e;
            font-size: 1.2em;
            border-bottom: 2px solid #3498db;
            padding-bottom: 8px;
        }

        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        input, textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
            min-width: 200px;
            font-family: inherit;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        button {
            padding: 10px 20px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }

        button:hover {
            background: #2980b9;
        }

        button:active {
            transform: translateY(1px);
        }

        button.danger {
            background: #e74c3c;
        }

        button.danger:hover {
            background: #c0392b;
        }

        button.success {
            background: #2ecc71;
        }

        button.success:hover {
            background: #27ae60;
        }

        .response {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 15px;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 12px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .response.empty {
            color: #999;
            font-style: italic;
        }

        .response.error {
            background: #fee;
            border-color: #fcc;
            color: #c00;
        }

        .response.success {
            background: #efe;
            border-color: #cfc;
        }

        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }

        .config {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Polyindex API Route Tester</h1>

        <div class="config">
            <strong>Base URL:</strong>
            <input type="text" id="baseUrl" value="http://localhost:8000" style="width: 300px; margin-left: 10px;">
        </div>

        <!-- Health Check -->
        <div class="section">
            <h2>Health Check</h2>
            <div class="controls">
                <button onclick="checkHealth()">GET /health</button>
            </div>
            <div id="healthResponse" class="response empty">No response yet</div>
        </div>

        <!-- Related Bets -->
        <div class="section">
            <h2>Related Bets</h2>

            <div class="controls">
                <input type="text" id="relatedBetsMarketId" placeholder="CLOB Market ID (condition_id)" style="flex: 2;">
                <button onclick="submitRelatedBets()">POST /api/related-bets</button>
            </div>
            <div id="submitRelatedBetsResponse" class="response empty">No response yet</div>
            <div id="relatedBetsLogResponse" class="response empty" style="margin-top: 10px;">No logs yet</div>
        </div>

        <!-- Relations Analyzer -->
        <div class="section">
            <h2>Relations Analyzer</h2>

            <div class="controls">
                <textarea id="relationsPayload" placeholder="JSON payload for /api/relations/price" style="min-height: 400px;">{
  "root": {
    "id": "trump-wins-nomination",
    "probability": 0.65,
    "weight": 1.0,
    "decision": "yes"
  },
  "dependants": [
    {
      "id": "trump-wins-iowa",
      "probability": 0.75,
      "relation": "SUBEVENT"
    },
    {
      "id": "biden-wins-nomination",
      "probability": 0.42,
      "relation": "CONTRADICTS"
    },
    {
      "id": "trump-wins-general",
      "probability": 0.48,
      "relation": "IMPLIES"
    },
    {
      "id": "desantis-wins-nomination",
      "probability": 0.18,
      "relation": "CONTRADICTS"
    },
    {
      "id": "haley-wins-nomination",
      "probability": 0.12,
      "relation": "CONTRADICTS"
    },
    {
      "id": "other-gop-nominee",
      "probability": 0.05,
      "relation": "CONTRADICTS"
    }
  ],
  "volatility": 1.2,
  "options": {
    "epsilon": 0.01
  }
}</textarea>
            </div>
            <div class="controls">
                <button onclick="priceRelations()">POST /api/relations/price</button>
                <button onclick="loadSimpleExample()">Load Simple Example</button>
                <button onclick="loadArbitrageExample()">Load Arbitrage Example</button>
            </div>
            <div id="relationsResponse" class="response empty">No response yet</div>
        </div>

        <!-- Relations Graph Outcomes -->
        <div class="section">
            <h2>Relations Graph Outcomes</h2>

            <div class="controls">
                <textarea id="relationsGraphPayload" placeholder="JSON payload for /api/relations/graph" style="min-height: 220px;">{
  "id": "root",
  "probability": 0.6,
  "weight": 1,
  "decision": "yes",
  "children": [
    {
      "id": "event-a",
      "probability": 0.4,
      "weight": 0.5,
      "decision": "yes",
      "relation": "IMPLIES"
    },
    {
      "id": "event-b",
      "probability": 0.35,
      "weight": 0.4,
      "decision": "no",
      "relation": "CONTRADICTS"
    }
  ]
}</textarea>
            </div>
            <div class="controls">
                <button onclick="evaluateGraph()">POST /api/relations/graph</button>
            </div>
            <div id="relationsGraphResponse" class="response empty">No response yet</div>
        </div>

    </div>

    <script>
        function getBaseUrl() {
            return document.getElementById('baseUrl').value;
        }

        function displayResponse(elementId, data, isError = false) {
            const element = document.getElementById(elementId);
            element.className = 'response';
            if (isError) {
                element.classList.add('error');
            } else {
                element.classList.add('success');
            }
            element.textContent = JSON.stringify(data, null, 2);
        }

        async function checkHealth() {
            try {
                const response = await fetch(`${getBaseUrl()}/health`);
                const data = await response.json();
                displayResponse('healthResponse', data, !response.ok);
            } catch (error) {
                displayResponse('healthResponse', { error: error.message }, true);
            }
        }

        async function submitRelatedBets() {
            const marketId = document.getElementById('relatedBetsMarketId').value;
            if (!marketId) {
                alert('Please enter a market ID');
                return;
            }

            try {
                const response = await fetch(`${getBaseUrl()}/api/related-bets`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ marketId })
                });
                const logElement = document.getElementById('relatedBetsLogResponse');
                const logs = [];

                logElement.className = 'response';
                logElement.textContent = 'Streaming...';

                if (!response.body) {
                    displayResponse('submitRelatedBetsResponse', { error: 'No response body' }, true);
                    return;
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) {
                        break;
                    }

                    buffer += decoder.decode(value, { stream: true });
                    const parts = buffer.split('\n\n');
                    buffer = parts.pop() || '';

                    for (const part of parts) {
                        const line = part
                            .split('\n')
                            .find(segment => segment.startsWith('data:'));
                        if (!line) {
                            continue;
                        }

                        const data = line.slice(5).trim();
                        if (data.startsWith('log - ')) {
                            const payload = data.slice(6);
                            let logText = payload;
                            try {
                                const parsed = JSON.parse(payload);
                                logText = `[${parsed.level}] ${parsed.message}`;
                                if (parsed.meta !== undefined) {
                                    logText += ` ${JSON.stringify(parsed.meta)}`;
                                }
                            } catch (error) {
                                // Keep raw payload if JSON parsing fails
                            }

                            logs.push(logText);
                            logElement.textContent = logs.join('\n');
                            continue;
                        }

                        if (data.startsWith('final - ')) {
                            const payload = data.slice(8);
                            let finalData = payload;
                            try {
                                finalData = JSON.parse(payload);
                            } catch (error) {
                                // Keep raw payload if JSON parsing fails
                            }

                            displayResponse('submitRelatedBetsResponse', finalData, !response.ok);
                        }
                    }
                }

                if (response.ok) {
                    document.getElementById('relatedBetsMarketId').value = '';
                }
            } catch (error) {
                displayResponse('submitRelatedBetsResponse', { error: error.message }, true);
            }
        }

        function loadSimpleExample() {
            document.getElementById('relationsPayload').value = JSON.stringify({
                "root": {
                    "id": "event-main",
                    "probability": 0.60,
                    "weight": 1.0,
                    "decision": "yes"
                },
                "dependants": [
                    {
                        "id": "event-a-implies",
                        "probability": 0.40,
                        "relation": "IMPLIES"
                    },
                    {
                        "id": "event-b-contradicts",
                        "probability": 0.35,
                        "relation": "CONTRADICTS"
                    }
                ],
                "volatility": 1.0,
                "options": {
                    "epsilon": 0.01
                }
            }, null, 2);
        }

        function loadArbitrageExample() {
            document.getElementById('relationsPayload').value = JSON.stringify({
                "root": {
                    "id": "election-outcome",
                    "probability": 1.0,
                    "weight": 2.0,
                    "decision": "yes"
                },
                "dependants": [
                    {
                        "id": "candidate-a",
                        "probability": 0.30,
                        "relation": "PARTITION_OF"
                    },
                    {
                        "id": "candidate-b",
                        "probability": 0.25,
                        "relation": "PARTITION_OF"
                    },
                    {
                        "id": "candidate-c",
                        "probability": 0.20,
                        "relation": "PARTITION_OF"
                    },
                    {
                        "id": "candidate-d",
                        "probability": 0.15,
                        "relation": "PARTITION_OF"
                    }
                ],
                "volatility": 0.8,
                "options": {
                    "epsilon": 0.02
                }
            }, null, 2);
        }

        async function priceRelations() {
            const payloadText = document.getElementById('relationsPayload').value;
            let payload;

            try {
                payload = JSON.parse(payloadText);
            } catch (error) {
                displayResponse('relationsResponse', { error: 'Invalid JSON payload' }, true);
                return;
            }

            try {
                const response = await fetch(`${getBaseUrl()}/api/relations/price`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                displayResponse('relationsResponse', data, !response.ok);
            } catch (error) {
                displayResponse('relationsResponse', { error: error.message }, true);
            }
        }

        async function evaluateGraph() {
            const payloadText = document.getElementById('relationsGraphPayload').value;
            let payload;

            try {
                payload = JSON.parse(payloadText);
            } catch (error) {
                displayResponse('relationsGraphResponse', { error: 'Invalid JSON payload' }, true);
                return;
            }

            try {
                const response = await fetch(`${getBaseUrl()}/api/relations/graph`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });
                const data = await response.json();
                displayResponse('relationsGraphResponse', data, !response.ok);
            } catch (error) {
                displayResponse('relationsGraphResponse', { error: error.message }, true);
            }
        }

    </script>
</body>
</html>
